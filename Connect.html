<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connect MetaMask Wallet</title>
</head>
<body>
  <h1>Connect Your Wallet</h1>
  <button onclick="connectWallet()">Connect MetaMask</button>
  <p id="status"></p>

  <script>
    // Replace with your initial JWT from login
    const initialToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3R1c2VyMTIzQGdtYWlsLmNvbSIsImlhdCI6MTc0MjY0NDEyMCwiZXhwIjoxNzQyNjQ3NzIwfQ.-YqlSXQtk0JqvxEgvAUOfQG0qpNgfPMEVcOFACUslGw"; // From /login endpoint
    const backendUrl = "http://localhost:3005/connect-wallet"; // Updated endpoint name to match backend

    async function connectWallet() {
      const status = document.getElementById("status");
      status.textContent = "Connecting...";

      try {
        // Check for MetaMask first
        if (!window.ethereum) {
          throw new Error("MetaMask not detected. Please install MetaMask.");
        }

        // Request account access
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts",
        });
        const walletAddress = accounts[0];
        
        // Step 1: Get nonce from backend
        const nonceResponse = await fetch(backendUrl, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${initialToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ walletAddress }),
        });

        if (!nonceResponse.ok) {
          throw new Error("Failed to get nonce: " + await nonceResponse.text());
        }

        const { nonce } = await nonceResponse.json();
        status.textContent = "Nonce received. Please sign the message in MetaMask...";

        // Step 2: Sign the message
        const message = `Sign this nonce to authenticate: ${nonce}`;
        const signature = await window.ethereum.request({
          method: "personal_sign",
          params: [message, walletAddress],
        });

        status.textContent = "Signature obtained. Verifying with backend...";

        // Step 3: Send signature to backend to link wallet
        const verifyResponse = await fetch(backendUrl, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${initialToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            walletAddress,
            signature,
          }),
        });

        if (!verifyResponse.ok) {
          throw new Error("Failed to verify: " + await verifyResponse.text());
        }

        const { token } = await verifyResponse.json();
        status.textContent = "Wallet connected successfully!";
        
        // Store the new token for future use
        localStorage.setItem("walletToken", token);
        console.log("New JWT with wallet:", token);
      } catch (error) {
        status.textContent = "Error: " + error.message;
        console.error("Wallet connection error:", error);
      }
    }
  </script>
</body>
</html>